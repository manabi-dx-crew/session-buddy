# Session Buddy UI改善機能ガイド 🚀

## 📋 概要

フィードバックを基に、Session BuddyのUIを大幅に改善しました！
初見ユーザーへの配慮と勉強会・LT会での使いやすさを重視した機能を追加しています。

## 🌟 新機能一覧

### 1. ウェルカムスクリーン（前室画面）
- **目的**: 初見ユーザーへの説明とシステム理解の促進
- **機能**: 
  - システムの説明と注意事項表示
  - 世界観に合ったターミナル風デザイン
  - 「ENTER SYSTEM」ボタンでメイン画面へ遷移
- **スキップ方法**: `?skip_welcome=true`

### 2. 初期プロンプト改善
- **目的**: 世界観に合った魅力的なきっかけ作り
- **機能**:
  - コンテキストに応じたプロンプト自動選択
  - 「君のコードネームを教えてくれ！」などの世界観重視プロンプト
  - 初回応答の自動フォローアップ
- **カスタマイズ**: `?prompt_type=codename|study|tech|casual`

### 3. ポップアップウィンドウ機能
- **目的**: 勉強会での使いやすさ向上
- **機能**:
  - 適切なサイズ（800x600）での別ウィンドウ表示
  - 画面中央配置
  - ポップアップボタンの自動追加
- **使用方法**: 右上の「📱 ポップアップで開く」ボタンまたは `?popup=true`

### 4. URLパラメータ機能強化
- **目的**: 柔軟な設定切り替えとiframe対応
- **機能**:
  - アバター設定: `?modelno=1|2`
  - 勉強会モード: `?study_mode=true`
  - コンパクトUI: `?compact_ui=true`
  - セッション名表示: `?session_name=勉強会名`

### 5. 応答最適化機能
- **目的**: 冗長な回答を勉強会に適した形に最適化
- **機能**:
  - 文字数制限（勉強会モード時200文字）
  - ギャル口調への自動変換
  - 箇条書き優先表示
  - 絵文字自動追加

## 🔗 アクセス情報

### メインURL
```
https://avatar-ui-core-service-475598051239.asia-northeast1.run.app
```

### エイリアスURL
```
https://avatar-ui-core-service-v7qdibm4ra-an.a.run.app
```

## 📖 使用方法

### 基本的な使用方法

1. **通常アクセス**
   ```
   https://avatar-ui-core-service-475598051239.asia-northeast1.run.app
   ```
   - ウェルカムスクリーンが表示
   - 「ENTER」ボタンでシステム開始

2. **ウェルカムスクリーンをスキップ**
   ```
   https://avatar-ui-core-service-475598051239.asia-northeast1.run.app?skip_welcome=true
   ```

3. **ポップアップモード**
   ```
   https://avatar-ui-core-service-475598051239.asia-northeast1.run.app?popup=true&skip_welcome=true
   ```

### 勉強会・LT会向け設定

#### 🎓 勉強会モード（推奨）
```
https://avatar-ui-core-service-475598051239.asia-northeast1.run.app?study_mode=true&popup=true&session_name=第3回AI勉強会&modelno=2
```

**特徴**:
- 短縮応答（200文字以内）
- セッション名をヘッダーに表示
- ポップアップウィンドウで開く
- いぬバディアバター使用

#### 📱 コンパクトモード
```
https://avatar-ui-core-service-475598051239.asia-northeast1.run.app?compact_ui=true&popup=true
```

**特徴**:
- 小さなアバター表示
- コンパクトなUI
- 画面占有面積を最小化

### アバター設定

#### Spectra（デフォルト）
```
?modelno=1
```

#### いぬバディ
```
?modelno=2
```

#### カスタム名前
```
?modelno=2&avatar_name=ミカりん
```

### 高度な設定

#### プロンプトタイプ設定
```
?prompt_type=codename    # コードネーム系
?prompt_type=study       # 学習系
?prompt_type=tech        # 技術系
?prompt_type=casual      # カジュアル系
```

#### 応答設定
```
?max_response_length=150    # 最大文字数
?politeness=casual          # 口調（casual/polite/formal）
?emojis=true               # 絵文字使用
```

#### デバッグモード
```
?debug=true&verbose=true
```

## 🧪 テスト手順

### 1. ウェルカムスクリーン テスト

**手順**:
1. メインURLにアクセス
2. ウェルカムスクリーンが表示されることを確認
3. 「ENTER」ボタンをクリック
4. メイン画面に遷移することを確認

**期待結果**:
- ターミナル風のウェルカムスクリーン表示
- アニメーション効果
- スムーズな画面遷移

### 2. 初期プロンプト テスト

**手順**:
1. システム開始後、初期プロンプトを確認
2. 名前を入力（例：「ミカりん」）
3. 適切なフォローアップが返されることを確認

**期待結果**:
- 「君のコードネームを教えてくれ！」などのプロンプト表示
- 入力に応じた適切なフォローアップ

### 3. ポップアップ機能 テスト

**手順**:
1. 右上の「📱 ポップアップで開く」ボタンをクリック
2. 新しいウィンドウが開くことを確認
3. サイズと位置が適切であることを確認

**期待結果**:
- 800x600サイズのポップアップ
- 画面中央配置
- 正常なチャット機能

### 4. アバター切り替え テスト

**手順**:
1. `?modelno=1` でアクセス → Spectra表示確認
2. `?modelno=2` でアクセス → いぬバディ表示確認
3. チャット中の口パクアニメーション確認

**期待結果**:
- 正しいアバター画像表示
- 名前の切り替え
- 口パクアニメーション動作

### 5. 勉強会モード テスト

**手順**:
1. `?study_mode=true&session_name=テスト勉強会` でアクセス
2. セッション名がヘッダーに表示されることを確認
3. 短縮応答が返されることを確認

**期待結果**:
- セッション名表示
- 200文字以内の応答
- 勉強会向け最適化

### 6. 応答最適化 テスト

**手順**:
1. 長い質問を入力
2. 応答が適切に短縮されることを確認
3. ギャル口調で返されることを確認

**期待結果**:
- 冗長性の除去
- 適切な文字数制限
- ギャル口調への変換

## 🔧 トラブルシューティング

### よくある問題

#### 1. チャット応答が上書きされる（2025年9月18日解決済み）
**症状**: Dify APIの応答が表示された後、すぐに別の応答に上書きされる

**原因**: 
- UI内部システムの応答最適化処理
- 初回メッセージのフォローアップ処理

**解決方法**:
- 上書き処理は既に無効化済み
- Dify APIの応答がそのまま表示される
- 問題が再発した場合は開発者に連絡

#### 2. アバター表示が不整合（2025年9月18日解決済み）
**症状**: アバター名が`SPECTRA`だが、画像は`idle_inu.png`

**原因**: 
- アバター切り替えの初期化タイミングの問題

**解決方法**:
- 表示は既に`INU BUDDY`に統一済み
- ウェルカムスクリーン遷移時に正しく設定される
- 問題が再発した場合はページをリロード

#### 3. チャット時に「エラーが発生しました」が表示される
**症状**: メッセージ送信時にエラーメッセージが表示される

**原因**: 
- Cloud Run環境変数で`DIFY_BASE_URL`が設定されていない
- APIキーが無効または権限不足

**解決方法**:
```bash
# 環境変数の完全設定
gcloud run services update avatar-ui-core-service \
  --region asia-northeast1 \
  --update-env-vars="DIFY_BASE_URL=https://dify-session-buddy-475598051239.asia-northeast1.run.app,DIFY_API_KEY=your-api-key,AI_PROVIDER=dify"

# Dify API直接テスト
python test_dify_direct.py
```

#### 4. ウェルカムスクリーンが表示されない
**解決方法**: 
- キャッシュをクリアしてリロード
- `?skip_welcome=false` を明示的に指定

#### 5. ポップアップがブロックされる
**解決方法**:
- ブラウザのポップアップ設定を確認
- サイトを信頼済みサイトに追加

#### 6. アバター画像が表示されない
**解決方法**:
- ネットワーク接続を確認
- ブラウザの開発者ツールでエラーを確認

#### 7. 応答が最適化されない（2025年9月18日変更）
**注意**: 応答最適化機能は無効化されています
- Dify APIの応答がそのまま表示されます
- 上書き処理は完全に無効化済み
- 純粋なDifyの応答を確認できます

### デバッグ方法

#### コンソールログ確認
```javascript
// ブラウザの開発者ツール > Console で確認
console.log('現在の設定:', window.urlParamsManager.config);
console.log('アバター設定:', window.avatarSwitcher.settings);
```

#### 設定確認
```
?debug=true
```
を追加してアクセスすると、画面左上にデバッグ情報が表示されます。

## 📊 パフォーマンス情報

### 読み込み時間
- 初回アクセス: 約2-3秒
- キャッシュ後: 約1秒以下

### 対応ブラウザ
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### モバイル対応
- レスポンシブデザイン対応
- タッチデバイス最適化済み

## 🎯 今後の拡張予定

1. **複数ワークフロー対応**
   - 異なるDifyワークフローの切り替え

2. **ユーザー認証機能**
   - 個人設定の保存

3. **会話履歴機能**
   - チャット履歴の永続化

4. **音声入力対応**
   - 音声認識機能

5. **カスタムアバター**
   - ユーザー独自のアバター画像

## 📞 サポート

問題が発生した場合は、以下の情報を添えてお知らせください：

1. 使用したURL（パラメータ含む）
2. ブラウザとバージョン
3. エラーメッセージ
4. 期待していた動作

---

